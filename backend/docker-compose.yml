# Docker Compose for mithran Backend
# SECURITY: All credentials must be set via environment variables
# Create a .env file in the backend directory with your credentials

services:
  # API Gateway - Main backend service
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: mithran-api-gateway
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-4000}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      SUPABASE_URL: ${SUPABASE_URL:?SUPABASE_URL is required}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY:?SUPABASE_SERVICE_KEY is required}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-15m}
      REFRESH_TOKEN_EXPIRATION: ${REFRESH_TOKEN_EXPIRATION:-7d}
      THROTTLE_TTL: ${THROTTLE_TTL:-60000}
      THROTTLE_LIMIT: ${THROTTLE_LIMIT:-100}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "${PORT:-4000}:4000"
    volumes:
      - .:/app
      - /app/node_modules
      - ./logs:/app/logs
    networks:
      - mithran-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  mithran-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
